# .mergify.yml
# Production-Ready Mergify Configuration with Mend Renovate Auto-Merge
# Last Updated: 2025-10-23

pull_request_rules:
  # ==========================================
  # RENOVATE/MEND AUTO-MERGE RULES
  # ==========================================

  # Auto-merge patch updates (0.0.X) - No approval needed
  - name: Auto-merge Renovate patch updates
    conditions:
      - author=renovate[bot]
      - or:
          - label=patch
          - title~=^(fix|chore)\(deps\)
          - and:
              - -label=major
              - -label=minor
      - status-success=ci/test
      - status-success=ci/lint
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
      - base=main
    actions:
      review:
        type: APPROVE
        message: |
          ✅ Auto-approving Renovate patch update
          
          Patch updates are low-risk and automatically approved after CI passes.
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - dependencies
          - auto-merged
          - patch
      delete_head_branch: {}

  # Auto-merge minor updates (0.X.0) - Single approval required
  - name: Auto-merge Renovate minor updates with approval
    conditions:
      - author=renovate[bot]
      - or:
          - label=minor
          - title~=^feat\(deps\)
      - -label=major
      - "#approved-reviews-by>=1"
      - status-success=ci/test
      - status-success=ci/lint
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
      - base=main
    actions:
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - dependencies
          - auto-merged
          - minor
      delete_head_branch: {}
      comment:
        message: |
          ✅ Auto-merging minor update after approval

  # Auto-merge security updates regardless of version
  - name: Auto-merge Renovate security patches (HIGH PRIORITY)
    conditions:
      - author=renovate[bot]
      - or:
          - label=security
          - title~=(?i)(security|vulnerability|cve)
          - body~=(?i)(vulnerability|security|cve)
      - status-success=ci/test
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
    actions:
      review:
        type: APPROVE
        message: |
          🔒 Auto-approving security update
          
          Security patches are automatically approved and merged after CI passes.
      merge:
        method: squash
        commit_message: title+body
        priority: high
      label:
        add:
          - security-fix
          - auto-merged
          - high-priority
      delete_head_branch: {}

  # Auto-merge devDependencies updates
  - name: Auto-merge Renovate devDependencies
    conditions:
      - author=renovate[bot]
      - or:
          - label=devDependencies
          - title~=\(dev-dependencies\)
          - body~=devDependencies
      - status-success=ci/test
      - status-success=ci/lint
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
    actions:
      review:
        type: APPROVE
        message: "Auto-approving dev dependency update"
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - dependencies
          - dev-dependencies
          - auto-merged
      delete_head_branch: {}

  # Auto-merge non-major Renovate updates (catch-all for patches/minors)
  - name: Auto-merge Renovate non-breaking updates
    conditions:
      - author=renovate[bot]
      - -label=major
      - -label=security  # Security handled by specific rule above
      - status-success=ci/test
      - status-success=ci/lint
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
      - base=main
    actions:
      review:
        type: APPROVE
        message: "Auto-approving non-breaking dependency update"
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - dependencies
          - auto-merged
      delete_head_branch: {}

  # Major updates - require team review with detailed checklist
  - name: Request review for Renovate major updates
    conditions:
      - author=renovate[bot]
      - label=major
      - -draft
    actions:
      request_reviews:
        teams:
          - platform-team
          - tech-leads
      label:
        add:
          - needs-review
          - breaking-change-possible
          - do-not-merge  # Remove this label manually after review
      comment:
        message: |
          🚨 **MAJOR DEPENDENCY UPDATE DETECTED**
          
          This is a major version update (X.0.0) that may contain breaking changes.
          
          **Review Checklist:**
          - [ ] Reviewed changelog/release notes for breaking changes
          - [ ] Checked migration guide (if available)
          - [ ] All tests passing (CI + manual testing)
          - [ ] No breaking changes affecting our codebase
          - [ ] Updated our code for any API changes
          - [ ] Documentation updated if needed
          - [ ] Considered impact on production
          
          **Actions Required:**
          1. Review the changes thoroughly
          2. Test locally if needed
          3. Remove `do-not-merge` label when ready
          4. Approve the PR
          
          Once approved with label removed, this will auto-merge.

  # Major updates - auto-merge after thorough review
  - name: Auto-merge approved Renovate major updates
    conditions:
      - author=renovate[bot]
      - label=major
      - "#approved-reviews-by>=2"
      - approved-reviews-by=@your-org/tech-leads
      - -label=do-not-merge
      - status-success=ci/test
      - status-success=ci/lint
      - status-success=security/scan
      - "#changes-requested-reviews-by=0"
      - -draft
      - -conflict
    actions:
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - dependencies
          - major-update
          - reviewed
      delete_head_branch: {}

  # ==========================================
  # RENOVATE PACKAGE MANAGER LABELING
  # ==========================================

  - name: Label npm/Node.js updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^package\.json$
          - files~=^package-lock\.json$
          - files~=^yarn\.lock$
          - files~=^pnpm-lock\.yaml$
    actions:
      label:
        add:
          - npm
          - javascript

  - name: Label Python/pip updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^requirements\.txt$
          - files~=^requirements/
          - files~=^setup\.py$
          - files~=^pyproject\.toml$
          - files~=^poetry\.lock$
          - files~=^Pipfile$
    actions:
      label:
        add:
          - python
          - pip

  - name: Label Docker updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=Dockerfile
          - files~=docker-compose
          - files~=\.dockerignore$
    actions:
      label:
        add:
          - docker
          - containers

  - name: Label GitHub Actions updates
    conditions:
      - author=renovate[bot]
      - files~=^\.github/workflows/
    actions:
      label:
        add:
          - github-actions
          - ci-cd
      request_reviews:
        teams:
          - devops-team
      comment:
        message: |
          🔧 **GitHub Actions Workflow Update**
          
          DevOps team has been requested for review.
          Please verify workflow changes before merging.

  - name: Label Terraform updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=\.tf$
          - files~=^terraform/
          - files~=\.tfvars$
    actions:
      label:
        add:
          - terraform
          - infrastructure
      request_reviews:
        teams:
          - platform-team
          - devops-team

  - name: Label Kubernetes/Helm updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^kubernetes/
          - files~=^k8s/
          - files~=^helm/
          - files~=Chart\.yaml$
          - files~=values\.yaml$
    actions:
      label:
        add:
          - kubernetes
          - helm
          - infrastructure
      request_reviews:
        teams:
          - platform-team

  - name: Label Go module updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^go\.mod$
          - files~=^go\.sum$
    actions:
      label:
        add:
          - go
          - golang

  - name: Label Ruby/Gem updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^Gemfile$
          - files~=^Gemfile\.lock$
    actions:
      label:
        add:
          - ruby
          - gems

  - name: Label Java/Maven updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=^pom\.xml$
          - files~=^build\.gradle$
    actions:
      label:
        add:
          - java
          - maven

  - name: Label .NET/NuGet updates
    conditions:
      - author=renovate[bot]
      - or:
          - files~=\.csproj$
          - files~=^packages\.config$
    actions:
      label:
        add:
          - dotnet
          - nuget

  # ==========================================
  # STANDARD PR AUTO-MERGE RULES
  # ==========================================

  # Auto-merge for fully approved PRs (non-Renovate)
  - name: Auto-merge approved PRs with all checks passing
    conditions:
      - -author=renovate[bot]
      - "#approved-reviews-by>=2"
      - "#changes-requested-reviews-by=0"
      - status-success=ci/test
      - status-success=ci/lint
      - status-success=security/scan
      - status-success=ci/build
      - base=main
      - -label=work-in-progress
      - -label=do-not-merge
      - -label=on-hold
      - -label=needs-discussion
      - -draft
      - -conflict
    actions:
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - merged
      delete_head_branch: {}

  # Hotfix fast-track with single approval
  - name: Fast-track merge for hotfixes
    conditions:
      - or:
          - label=hotfix
          - label=urgent
          - title~=(?i)\[hotfix\]
      - "#approved-reviews-by>=1"
      - approved-reviews-by=@your-org/tech-leads
      - status-success=ci/test
      - base=main
      - -draft
      - -conflict
    actions:
      merge:
        method: merge
        commit_message: title+body
        priority: high
      label:
        add:
          - merged-hotfix
          - expedited
      comment:
        message: |
          🚨 **Hotfix Merged**
          
          This hotfix was fast-tracked with expedited review process.

  # Documentation-only PRs - relaxed requirements
  - name: Auto-merge documentation PRs
    conditions:
      - or:
          - files~=^docs/
          - files~=\.md$
          - files~=^README
      - -files~=^(?!docs/|.*\.md$|README)
      - "#approved-reviews-by>=1"
      - base=main
      - -draft
      - -conflict
    actions:
      merge:
        method: squash
        commit_message: title+body
      label:
        add:
          - documentation
          - merged

  # ==========================================
  # BACKPORT AUTOMATION
  # ==========================================

  - name: Backport to release-1.x
    conditions:
      - merged
      - base=main
      - label=backport-1.x
    actions:
      backport:
        branches:
          - release-1.x
        labels:
          - backport

  - name: Backport to release-2.x
    conditions:
      - merged
      - base=main
      - label=backport-2.x
    actions:
      backport:
        branches:
          - release-2.x
        labels:
          - backport

  - name: Backport to all stable releases
    conditions:
      - merged
      - base=main
      - label=backport-all
    actions:
      backport:
        branches:
          - release-1.x
          - release-2.x
        labels:
          - backport

  # ==========================================
  # AUTO-LABELING BY FILE CHANGES
  # ==========================================

  - name: Label backend changes
    conditions:
      - or:
          - files~=^backend/
          - files~=^src/
          - files~=^api/
          - files~=^server/
    actions:
      label:
        add:
          - backend

  - name: Label frontend changes
    conditions:
      - or:
          - files~=^frontend/
          - files~=^web/
          - files~=^client/
          - files~=^ui/
    actions:
      label:
        add:
          - frontend

  - name: Label documentation changes
    conditions:
      - or:
          - files~=^docs/
          - files~=\.md$
          - files~=^README
          - files~=\.rst$
    actions:
      label:
        add:
          - documentation

  - name: Label infrastructure changes
    conditions:
      - or:
          - files~=^infrastructure/
          - files~=^terraform/
          - files~=\.tf$
          - files~=Dockerfile
          - files~=docker-compose
          - files~=^k8s/
          - files~=^kubernetes/
    actions:
      label:
        add:
          - infrastructure

  - name: Label CI/CD changes
    conditions:
      - or:
          - files~=^\.github/workflows/
          - files~=^\.gitlab-ci\.yml$
          - files~=^\.circleci/
          - files~=^Jenkinsfile$
          - files~=^\.travis\.yml$
    actions:
      label:
        add:
          - ci-cd

  - name: Label database changes
    conditions:
      - or:
          - files~=^migrations/
          - files~=^database/
          - files~=\.sql$
          - files~=^db/
    actions:
      label:
        add:
          - database
          - needs-data-review
      request_reviews:
        teams:
          - data-team

  - name: Label configuration changes
    conditions:
      - or:
          - files~=^config/
          - files~=\.env\.
          - files~=\.yaml$
          - files~=\.yml$
          - files~=\.toml$
          - files~=\.ini$
    actions:
      label:
        add:
          - configuration

  - name: Label test changes
    conditions:
      - or:
          - files~=^tests?/
          - files~=^__tests__/
          - files~=\.test\.
          - files~=\.spec\.
          - files~=^e2e/
    actions:
      label:
        add:
          - tests

  - name: Label security-related changes
    conditions:
      - or:
          - files~=^src/auth/
          - files~=^src/security/
          - files~=^security/
          - files~=\.pem$
          - files~=\.key$
          - title~=(?i)(security|vulnerability|auth|cve)
    actions:
      label:
        add:
          - security
          - needs-security-review
      request_reviews:
        teams:
          - security-team

  # ==========================================
  # TEAM-BASED REVIEW REQUESTS
  # ==========================================

  - name: Request backend team review
    conditions:
      - files~=^(backend|src|api|server)/
      - -draft
      - -author=renovate[bot]
      - -merged
      - -closed
    actions:
      request_reviews:
        teams:
          - backend-team

  - name: Request frontend team review
    conditions:
      - files~=^(frontend|web|client|ui)/
      - -draft
      - -author=renovate[bot]
      - -merged
      - -closed
    actions:
      request_reviews:
        teams:
          - frontend-team

  - name: Request DevOps team review for infrastructure
    conditions:
      - or:
          - files~=^infrastructure/
          - files~=^terraform/
          - files~=Dockerfile
          - files~=^k8s/
          - files~=^\.github/workflows/
      - -draft
      - -author=renovate[bot]
      - -merged
      - -closed
    actions:
      request_reviews:
        teams:
          - devops-team
          - platform-team

  - name: Request security team review
    conditions:
      - or:
          - files~=^src/auth/
          - files~=^src/security/
          - files~=^security/
          - label=security
      - -draft
      - -merged
      - -closed
    actions:
      request_reviews:
        teams:
          - security-team
      label:
        add:
          - needs-security-review

  - name: Request data team review for database changes
    conditions:
      - or:
          - files~=^migrations/
          - files~=^database/
          - files~=\.sql$
      - -draft
      - -author=renovate[bot]
      - -merged
      - -closed
    actions:
      request_reviews:
        teams:
          - data-team

  # ==========================================
  # PRIORITY LABELS
  # ==========================================

  - name: Add critical priority label
    conditions:
      - or:
          - title~=(?i)(\[critical\]|critical:|🚨|P0)
          - label=critical
    actions:
      label:
        add:
          - priority:critical
      comment:
        message: |
          🚨 **CRITICAL PRIORITY**
          
          This PR has been marked as critical priority.
          Please review and merge as soon as possible.

  - name: Add high priority label
    conditions:
      - or:
          - title~=(?i)(\[high\]|high:|⚠️|P1)
          - label=high-priority
    actions:
      label:
        add:
          - priority:high

  - name: Add medium priority label
    conditions:
      - title~=(?i)(\[medium\]|medium:|P2)
    actions:
      label:
        add:
          - priority:medium

  - name: Add low priority label
    conditions:
      - title~=(?i)(\[low\]|low:|P3)
    actions:
      label:
        add:
          - priority:low

  # ==========================================
  # SIZE-BASED RULES AND WARNINGS
  # ==========================================

  - name: Label extra small PRs
    conditions:
      - "#files<=3"
    actions:
      label:
        add:
          - size/xs

  - name: Label small PRs
    conditions:
      - "#files>3"
      - "#files<=10"
    actions:
      label:
        add:
          - size/small

  - name: Label medium PRs
    conditions:
      - "#files>10"
      - "#files<=25"
    actions:
      label:
        add:
          - size/medium

  - name: Label large PRs and warn
    conditions:
      - "#files>25"
      - "#files<=50"
      - -author=renovate[bot]
    actions:
      label:
        add:
          - size/large
      comment:
        message: |
          📊 **Large PR Detected**
          
          This PR modifies **{{ files | length }}** files.
          
          **Recommendations:**
          - Consider breaking into smaller PRs for easier review
          - Ensure comprehensive test coverage
          - Add detailed description of changes
          - May require additional review time

  - name: Label extra large PRs and request lead review
    conditions:
      - "#files>50"
      - -author=renovate[bot]
    actions:
      label:
        add:
          - size/xl
          - needs-extra-review
          - needs-lead-review
      request_reviews:
        teams:
          - tech-leads
      comment:
        message: |
          ⚠️ **EXTRA LARGE PR DETECTED**
          
          This PR modifies **{{ files | length }}** files - significantly above recommended size.
          
          **Required Actions:**
          - [ ] Tech lead review requested
          - [ ] PR description includes detailed breakdown
          - [ ] Consider splitting into multiple PRs
          - [ ] Comprehensive testing completed
          - [ ] Architecture review completed
          
          Tech leads have been automatically requested for review.

  # ==========================================
  # BRANCH UPDATE & CONFLICT MANAGEMENT
  # ==========================================

  - name: Auto-update branches for approved PRs
    conditions:
      - -draft
      - -conflict
      - base=main
      - or:
          - "#approved-reviews-by>=1"
          - author=renovate[bot]
      - -merged
      - -closed
    actions:
      update:
        method: merge

  - name: Label and notify on merge conflicts
    conditions:
      - conflict
      - -merged
      - -closed
    actions:
      label:
        add:
          - conflicts
          - needs-rebase
      comment:
        message: |
          ⚠️ **Merge Conflicts Detected**
          
          This PR has merge conflicts that must be resolved before merging.
          
          **To resolve:**
          ```bash
          git fetch origin
          git rebase origin/{{ base }}
          # Resolve conflicts
          git push --force-with-lease
          ```
          
          Or merge the base branch:
          ```bash
          git fetch origin
          git merge origin/{{ base }}
          # Resolve conflicts
          git push
          ```

  - name: Remove conflict label when resolved
    conditions:
      - -conflict
      - label=conflicts
    actions:
      label:
        remove:
          - conflicts
          - needs-rebase
      comment:
        message: |
          ✅ **Conflicts Resolved**
          
          Merge conflicts have been resolved. PR is ready for review.

  # ==========================================
  # STALE PR MANAGEMENT
  # ==========================================

  - name: Label stale PRs (14 days)
    conditions:
      - updated-at<14 days ago
      - -merged
      - -closed
      - -author=renovate[bot]
      - -label=on-hold
      - -label=long-term
    actions:
      label:
        add:
          - stale
      comment:
        message: |
          ⏰ **Stale PR Notice**
          
          This PR hasn't been updated in 14 days.
          
          **Please:**
          - Update the PR if work is ongoing
          - Add `on-hold` label if waiting on external factors
          - Close if no longer needed
          
          The PR will be closed automatically after 30 days of inactivity.

  - name: Close very stale PRs (30 days)
    conditions:
      - updated-at<30 days ago
      - -merged
      - -closed
      - -author=renovate[bot]
      - -label=on-hold
      - -label=long-term
      - label=stale
    actions:
      close:
        message: |
          🔒 **Closing Stale PR**
          
          This PR has been closed due to 30 days of inactivity.
          
          Feel free to:
          - Reopen if you want to continue work
          - Create a new PR with fresh changes
          - Contact the team if this was closed in error

  - name: Close abandoned WIP PRs (45 days)
    conditions:
      - or:
          - label=work-in-progress
          - draft
      - updated-at<45 days ago
      - -merged
      - -closed
      - -author=renovate[bot]
    actions:
      close:
        message: |
          🔒 **Closing Abandoned WIP**
          
          This work-in-progress PR has been closed after 45 days of inactivity.
          Feel free to reopen when ready to continue.

  # ==========================================
  # DRAFT PR HANDLING
  # ==========================================

  - name: Label draft PRs
    conditions:
      - draft
    actions:
      label:
        add:
          - work-in-progress
          - draft

  - name: Remove WIP labels when PR is ready
    conditions:
      - -draft
      - or:
          - label=work-in-progress
          - label=draft
    actions:
      label:
        remove:
          - work-in-progress
          - draft
      comment:
        message: |
          ✅ **PR Ready for Review**
          
          This PR is now ready for review!
          Reviews will be automatically requested based on the files changed.

  # ==========================================
  # BREAKING CHANGES DETECTION
  # ==========================================

  - name: Label breaking changes
    conditions:
      - or:
          - title~=(?i)(breaking|BREAKING CHANGE)
          - body~=(?i)BREAKING CHANGE
    actions:
      label:
        add:
          - breaking-change
          - needs-extra-review
      request_reviews:
        teams:
          - tech-leads
      comment:
        message: |
          ⚠️ **BREAKING CHANGE DETECTED**
          
          This PR contains breaking changes that may affect existing functionality.
          
          **Required Actions:**
          - [ ] Breaking changes documented in PR description
          - [ ] Migration guide provided (if applicable)
          - [ ] All affected teams notified
          - [ ] Backward compatibility considered
          - [ ] Deprecation warnings added (if applicable)
          - [ ] Release notes prepared
          
          Tech leads have been requested for review.

  # ==========================================
  # RELEASE MANAGEMENT
  # ==========================================

  - name: Label release PRs
    conditions:
      - or:
          - head~=^release/
          - title~=(?i)release
    actions:
      label:
        add:
          - release
          - do-not-merge
      comment:
        message: |
          🚀 **Release PR Created**
          
          **Pre-merge Checklist:**
          - [ ] All release notes updated
          - [ ] Version numbers bumped
          - [ ] CHANGELOG.md updated
          - [ ] QA sign-off received
          - [ ] Security review completed
          - [ ] Documentation updated
          - [ ] Migration guide created (if needed)
          - [ ] Rollback plan documented
          
          Remove `do-not-merge` label when ready to release.

  - name: Auto-merge release PRs when approved
    conditions:
      - head~=^release/
      - "#approved-reviews-by>=3"
      - approved-reviews-by=@your-org/tech-leads
      - -label=do-not-merge
      - status-success=ci/test
      - status-success=ci/lint
      - status-success=security/scan
      - base=main
    actions:
      merge:
        method: merge
        commit_message: title+body
      label:
        add:
          - released

  # ==========================================
  # SPECIAL AUTOMATION
  # ==========================================

  # Dismiss stale reviews on new commits
  - name: Dismiss stale reviews on new commits
    conditions:
      - base=main
      - "#commits-behind>0"
    actions:
      dismiss_reviews:
        approved: true
        changes_requested: false
        message: |
          New commits have been pushed. Please re-review the changes.

  # Auto-assign based on file patterns
  - name: Auto-assign backend changes to backend lead
    conditions:
      - files~=^backend/
      - -draft
      - -author=renovate[bot]
    actions:
      assign:
        add_users:
          - backend-lead

  - name: Auto-assign frontend changes to frontend lead
    conditions:
      - files~=^frontend/
      - -draft
      - -author=renovate[bot]
    actions:
      assign:
        add_users:
          - frontend-lead

  # Celebrate milestones
  - name: Celebrate PR milestones
    conditions:
      - or:
          - "#number=100"
          - "#number=500"
          - "#number=1000"
    actions:
      comment:
        message: |
          🎉🎉🎉 **MILESTONE ACHIEVED** 🎉🎉🎉
          
          This is PR #{{ number }}! 
          
          Thank you for your contributions to the project!

  # Require changelog entry for features
  - name: Require changelog for features
    conditions:
      - or:
          - label=feature
          - title~=^feat
      - -files~=^CHANGELOG
      - -label=skip-changelog
    actions:
      label:
        add:
          - needs-changelog
      comment:
        message: |
          📝 **Changelog Update Required**
          
          This PR adds a new feature but doesn't update the CHANGELOG.
          
          Please add an entry to CHANGELOG.md or add the `skip-changelog` label if not applicable.

  # WIP detection in title
  - name: Label WIP PRs from title
    conditions:
      - title~=(?i)(wip|work in progress|\[wip\])
      - -draft
    actions:
      label:
        add:
          - work-in-progress
      comment:
        message: |
          🚧 **Work in Progress Detected**
          
          This PR appears to be a work in progress based on the title.
          Consider converting to a draft PR for better visibility.

  # ==========================================
  # COMPLIANCE & GOVERNANCE
  # ==========================================

  - name: Require CODEOWNERS approval
    conditions:
      - files~=^(src/critical/|security/|auth/)
      - -approved-reviews-by=@your-org/code-owners
    actions:
      label:
        add:
          - needs-codeowner-approval
      comment:
        message: |
          🔐 **CODEOWNERS Approval Required**
          
          Changes to critical files require approval from code owners.
          A review has been automatically requested.
      request_reviews:
        teams:
          - code-owners

  - name: Block merge without required labels
    conditions:
      - or:
          - label=do-not-merge
          - label=blocked
          - label=needs-discussion
    actions:
      comment:
        message: |
          🚫 **Merge Blocked**
          
          This PR cannot be merged due to blocking labels:
          {{ labels | join(', ') }}
          
          Please resolve the blocking issues and remove the labels to proceed.

  # ==========================================
  # QUEUE MANAGEMENT
  # ==========================================

  # Queue merge for business hours only (optional)
  # - name: Queue merge during business hours
  #   conditions:
  #     - "#approved-reviews-by>=2"
  #     - status-success=ci/test
  #     - base=main
  #     - schedule=Mon-Fri 09:00-17:00[America/New_York]
  #   actions:
  #     merge:
  #       method: squash

  # ==========================================
  # NOTIFICATION RULES
  # ==========================================

  - name: Notify on CI failure
    conditions:
      - or:
          - status-failure=ci/test
          - status-failure=ci/lint
      - -draft
    actions:
      label:
        add:
          - ci-failed
      comment:
        message: |
          ❌ **CI Checks Failed**
          
          One or more CI checks have failed. Please review the logs and fix the issues.
          
          Failed checks:
          - {{ status-failure }}

  - name: Remove CI failure label on success
    conditions:
      - status-success=ci/test
      - status-success=ci/lint
      - label=ci-failed
    actions:
      label:
        remove:
          - ci-failed
